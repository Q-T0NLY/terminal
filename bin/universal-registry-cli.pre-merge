#!/usr/bin/env bash
#
# Universal Hyper Registry - Complete Platform CLI
# Full control over plugins, microservices, streams, webhooks, and all features
# Version: âˆž.9
#

set -euo pipefail

# Configuration
REGISTRY_API="${UNIVERSAL_REGISTRY_API:-http://localhost:8080/api/v1}"
REGISTRY_DB="${UNIVERSAL_REGISTRY_DB:-/var/lib/ose/plugins/registry.db}"
CLI_VERSION="âˆž.9"

# Colors
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly PURPLE='\033[0;35m'
readonly CYAN='\033[0;36m'
readonly WHITE='\033[1;37m'
readonly NC='\033[0m'

# Icons
readonly ICON_SUCCESS="âœ“"
readonly ICON_ERROR="âœ—"
readonly ICON_WARNING="âš "
readonly ICON_INFO="â„¹"
readonly ICON_ROCKET="ï¿½ï¿½"
readonly ICON_SEARCH="ðŸ”"
readonly ICON_PLUGIN="ðŸ”Œ"
readonly ICON_GEAR="âš™ï¸"

print_success() { echo -e "${GREEN}${ICON_SUCCESS}${NC} $1"; }
print_error() { echo -e "${RED}${ICON_ERROR}${NC} $1" >&2; }
print_warning() { echo -e "${YELLOW}${ICON_WARNING}${NC} $1"; }
print_info() { echo -e "${CYAN}${ICON_INFO}${NC} $1"; }

print_header() {
    echo -e "\n${WHITE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${CYAN}$1${NC}"
    echo -e "${WHITE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
}

check_registry() {
    if ! curl -s "${REGISTRY_API%/api/v1}/health" > /dev/null 2>&1; then
        print_error "Cannot connect to Universal Registry"
        print_info "Start with: python3 /workspaces/terminal/modules/universal-registry/hyper_registry.py"
        return 1
    fi
    return 0
}

# ==================== PLUGIN MANAGEMENT ====================

cmd_plugin() {
    case "${1:-list}" in
        list|ls)
            print_header "${ICON_PLUGIN} Registered Plugins"
            check_registry || return 1
            
            curl -s "${REGISTRY_API}/entities?type=plugin" | python3 -c "
import sys, json
try:
    data = json.load(sys.stdin)
    if not data:
        print('  No plugins registered yet')
    else:
        print(f'{\"ID\":<30} {\"Name\":<35} {\"Version\":<10} {\"Status\":<12} {\"Feature\"}')
        print('-' * 115)
        for p in data:
            icon = 'âœ“' if p.get('status') == 'active' else 'â—‹'
            feat = p.get('metadata', {}).get('feature', 'N/A')
            print(f'{icon} {p[\"id\"]:<29} {p[\"name\"]:<35} {p.get(\"version\", \"N/A\"):<10} {p.get(\"status\", \"N/A\"):<12} {feat}')
except Exception as e:
    print(f'Error: {e}')
"
            ;;
        register|add)
            print_header "Register New Plugin"
            read -p "  Plugin Name: " pname
            read -p "  Version: " pver
            read -p "  Feature (ai-ml/web3/cloud/data/devops/security): " pfeat
            read -p "  Description: " pdesc
            read -p "  Author: " pauthor
            
            curl -s -X POST "${REGISTRY_API}/entities" \
                -H "Content-Type: application/json" \
                -d "{\"type\":\"plugin\",\"name\":\"$pname\",\"version\":\"$pver\",\"metadata\":{\"feature\":\"$pfeat\",\"description\":\"$pdesc\",\"author\":\"$pauthor\"}}" | python3 -m json.tool
            print_success "Plugin registered"
            ;;
        install)
            [ -z "${2:-}" ] && { print_error "Plugin ID required"; exit 1; }
            print_info "Installing plugin: $2"
            curl -s -X POST "${REGISTRY_API}/plugins/$2/install" | python3 -m json.tool
            ;;
        activate|enable|start)
            [ -z "${2:-}" ] && { print_error "Plugin ID required"; exit 1; }
            print_info "Activating plugin: $2"
            curl -s -X POST "${REGISTRY_API}/plugins/$2/activate" | python3 -m json.tool
            ;;
        deactivate|disable|stop)
            [ -z "${2:-}" ] && { print_error "Plugin ID required"; exit 1; }
            print_warning "Deactivating plugin: $2"
            curl -s -X POST "${REGISTRY_API}/plugins/$2/deactivate" | python3 -m json.tool
            ;;
        uninstall|remove|delete)
            [ -z "${2:-}" ] && { print_error "Plugin ID required"; exit 1; }
            read -p "Are you sure? (yes/no): " confirm
            [[ "$confirm" != "yes" ]] && { print_info "Cancelled"; exit 0; }
            print_warning "Uninstalling plugin: $2"
            curl -s -X DELETE "${REGISTRY_API}/plugins/$2" | python3 -m json.tool
            ;;
        info|show|get)
            [ -z "${2:-}" ] && { print_error "Plugin ID required"; exit 1; }
            print_header "Plugin Details: $2"
            curl -s "${REGISTRY_API}/entities/$2" | python3 -m json.tool
            ;;
        update)
            [ -z "${2:-}" ] && { print_error "Plugin ID required"; exit 1; }
            print_info "Updating plugin: $2"
            curl -s -X PUT "${REGISTRY_API}/plugins/$2/update" | python3 -m json.tool
            ;;
        health|status)
            [ -z "${2:-}" ] && { print_error "Plugin ID required"; exit 1; }
            curl -s "${REGISTRY_API}/plugins/$2/health" | python3 -m json.tool
            ;;
        logs)
            [ -z "${2:-}" ] && { print_error "Plugin ID required"; exit 1; }
            print_header "Plugin Logs: $2"
            curl -s "${REGISTRY_API}/plugins/$2/logs" | python3 -c "
import sys, json
data = json.load(sys.stdin)
for log in data.get('logs', []):
    print(f'[{log[\"timestamp\"]}] {log[\"level\"]}: {log[\"message\"]}')
"
            ;;
        *)
            echo "Plugin actions: list|register|install|activate|deactivate|uninstall|info|update|health|logs"
            exit 1
            ;;
    esac
}

# ==================== MICROSERVICES MANAGEMENT ====================

cmd_service() {
    case "${1:-list}" in
        list|ls)
            print_header "${ICON_ROCKET} Microservices"
            check_registry || return 1
            
            curl -s "${REGISTRY_API}/services" | python3 -c "
import sys, json
try:
    data = json.load(sys.stdin)
    services = data.get('services', {})
    if not services:
        print('  No microservices registered')
    else:
        print(f'{\"ID\":<25} {\"Name\":<30} {\"Port\":<6} {\"Status\":<12} {\"Health\"}')
        print('-' * 95)
        for sid, info in services.items():
            status = info.get('status', 'unknown')
            icon = 'âœ“' if status == 'active' else 'âœ—'
            print(f'{icon} {sid:<24} {info.get(\"name\", \"N/A\"):<30} {info.get(\"port\", \"N/A\"):<6} {status:<12} {info.get(\"health\", \"unknown\")}')
except Exception as e:
    print(f'Error: {e}')
"
            ;;
        register|add)
            print_header "Register Microservice"
            read -p "  Service ID: " sid
            read -p "  Service Name: " sname
            read -p "  Port: " sport
            read -p "  Description: " sdesc
            read -p "  Category (application/database/cache/monitoring): " scat
            
            curl -s -X POST "${REGISTRY_API}/services/register" \
                -H "Content-Type: application/json" \
                -d "{\"id\":\"$sid\",\"name\":\"$sname\",\"port\":$sport,\"description\":\"$sdesc\",\"category\":\"${scat:-application}\"}" | python3 -m json.tool
            print_success "Service registered"
            ;;
        start)
            [ -z "${2:-}" ] && { print_error "Service ID required"; exit 1; }
            print_info "Starting service: $2"
            curl -s -X POST "${REGISTRY_API}/services/$2/start" | python3 -m json.tool
            ;;
        stop)
            [ -z "${2:-}" ] && { print_error "Service ID required"; exit 1; }
            print_warning "Stopping service: $2"
            curl -s -X POST "${REGISTRY_API}/services/$2/stop" | python3 -m json.tool
            ;;
        restart)
            [ -z "${2:-}" ] && { print_error "Service ID required"; exit 1; }
            print_info "Restarting service: $2"
            curl -s -X POST "${REGISTRY_API}/services/$2/restart" | python3 -m json.tool
            ;;
        logs)
            [ -z "${2:-}" ] && { print_error "Service ID required"; exit 1; }
            print_header "Service Logs: $2"
            curl -s "${REGISTRY_API}/services/$2/logs?lines=${3:-100}" | python3 -c "
import sys, json
data = json.load(sys.stdin)
for log in data.get('logs', []):
    print(f'[{log[\"timestamp\"]}] {log[\"level\"]}: {log[\"message\"]}')
"
            ;;
        health|status)
            [ -z "${2:-}" ] && { print_error "Service ID required"; exit 1; }
            curl -s "${REGISTRY_API}/services/$2/health" | python3 -m json.tool
            ;;
        *)
            echo "Service actions: list|register|start|stop|restart|logs|health"
            ;;
    esac
}

# ==================== EVENT STREAMS ====================

cmd_stream() {
    case "${1:-list}" in
        list|ls)
            print_header "ðŸ“¡ Event Streams"
            check_registry || return 1
            curl -s "${REGISTRY_API}/streams/stats" | python3 -m json.tool
            ;;
        subscribe|sub)
            local event_type="${2:-*}"
            print_info "Subscribing to events: $event_type"
            echo -e "${YELLOW}âš ${NC} Press Ctrl+C to stop\n"
            curl -s -N "${REGISTRY_API}/streams/subscribe?event_type=$event_type" | while read line; do
                echo -e "${GREEN}ðŸ“¨${NC} $line"
            done
            ;;
        publish|pub)
            print_header "Publish Event"
            read -p "  Event Type: " etype
            read -p "  Source: " esrc
            read -p "  Data (JSON): " edata
            
            curl -s -X POST "${REGISTRY_API}/streams/publish" \
                -H "Content-Type: application/json" \
                -d "{\"type\":\"$etype\",\"source\":\"$esrc\",\"data\":$edata}" | python3 -m json.tool
            ;;
        *)
            echo "Stream actions: list|subscribe|publish"
            ;;
    esac
}

# ==================== WEBHOOKS ====================

cmd_webhook() {
    case "${1:-list}" in
        list|ls)
            print_header "ðŸª Registered Webhooks"
            check_registry || return 1
            curl -s "${REGISTRY_API}/webhooks" | python3 -m json.tool
            ;;
        add|register)
            print_header "Register Webhook"
            read -p "  Webhook URL: " url
            read -p "  Events (comma-separated): " events
            read -p "  Secret (optional): " secret
            
            events_json=$(echo "$events" | sed 's/,/","/g' | sed 's/^/["/;s/$/"]/')
            curl -s -X POST "${REGISTRY_API}/webhooks" \
                -H "Content-Type: application/json" \
                -d "{\"url\":\"$url\",\"events\":$events_json,\"secret\":\"$secret\"}" | python3 -m json.tool
            print_success "Webhook registered"
            ;;
        delete|remove)
            [ -z "${2:-}" ] && { print_error "Webhook ID required"; exit 1; }
            curl -s -X DELETE "${REGISTRY_API}/webhooks/$2" | python3 -m json.tool
            ;;
        test)
            [ -z "${2:-}" ] && { print_error "Webhook ID required"; exit 1; }
            print_info "Testing webhook: $2"
            curl -s -X POST "${REGISTRY_API}/webhooks/$2/test" | python3 -m json.tool
            ;;
        *)
            echo "Webhook actions: list|add|delete|test"
            ;;
    esac
}

# ==================== SEARCH & INDEX ====================

cmd_search() {
    local query="${1:-}"
    [ -z "$query" ] && { print_error "Search query required"; exit 1; }
    
    print_header "${ICON_SEARCH} Search Results"
    check_registry || return 1
    
    curl -s -X POST "${REGISTRY_API}/search" \
        -H "Content-Type: application/json" \
        -d "{\"query\":\"$query\"}" | python3 -c "
import sys, json
data = json.load(sys.stdin)
for result in data:
    score = int(result.get('score', 0) * 100)
    print(f'[{score}%] {result[\"name\"]} ({result[\"type\"]})')
    if 'description' in result.get('metadata', {}):
        print(f'      {result[\"metadata\"][\"description\"]}')
    print()
"
}

cmd_index() {
    case "${1:-stats}" in
        add)
            print_header "Index Document"
            read -p "  Document ID: " docid
            read -p "  Name: " name
            read -p "  Description: " desc
            read -p "  Category: " cat
            
            curl -s -X POST "${REGISTRY_API}/search/index" \
                -H "Content-Type: application/json" \
                -d "{\"id\":\"$docid\",\"name\":\"$name\",\"description\":\"$desc\",\"category\":\"$cat\"}" | python3 -m json.tool
            ;;
        stats)
            print_header "ðŸ” Search Index Statistics"
            check_registry || return 1
            curl -s "${REGISTRY_API}/search/stats" | python3 -m json.tool
            ;;
        rebuild)
            print_warning "Rebuilding search index..."
            curl -s -X POST "${REGISTRY_API}/search/rebuild" | python3 -m json.tool
            ;;
        *)
            echo "Index actions: add|stats|rebuild"
            ;;
    esac
}

# ==================== FEATURES & RELATIONSHIPS ====================

cmd_feature() {
    print_header "Feature Categories"
    check_registry || return 1
    
    curl -s "${REGISTRY_API}/entities?type=feature" | python3 -c "
import sys, json
data = json.load(sys.stdin)
if not data:
    print('  No features found')
else:
    for feat in data:
        print(f'â€¢ {feat[\"name\"]}: {feat.get(\"metadata\", {}).get(\"description\", \"\")}')
"
}

cmd_graph() {
    local entity_id="${1:-}"
    local depth="${2:-3}"
    [ -z "$entity_id" ] && { print_error "Entity ID required"; exit 1; }
    
    print_header "Dependency Graph: $entity_id"
    check_registry || return 1
    
    curl -s "${REGISTRY_API}/graph?root_id=$entity_id&depth=$depth" | python3 -c "
import sys, json
data = json.load(sys.stdin)
print(f'Root: {data[\"root_id\"]} (depth: {data[\"depth\"]})')
print(f'\nNodes: {len(data[\"nodes\"])}')
for node in data['nodes']:
    print(f'  â€¢ {node[\"name\"]} ({node[\"type\"]})')
print(f'\nEdges: {len(data[\"edges\"])}')
for edge in data['edges']:
    print(f'  â€¢ {edge[\"source_id\"]} â†’ {edge[\"target_id\"]} ({edge[\"type\"]})')
"
}

# ==================== SYSTEM OPERATIONS ====================

cmd_health() {
    print_header "System Health Check"
    check_registry || return 1
    
    curl -s "${REGISTRY_API%/api/v1}/health" | python3 -c "
import sys, json
data = json.load(sys.stdin)
print(f'Status: {data.get(\"status\", \"unknown\")}')
print(f'Timestamp: {data.get(\"timestamp\", \"N/A\")}')
if 'stats' in data:
    stats = data['stats']
    print(f'\nStatistics:')
    print(f'  Total Entities: {stats.get(\"total_entities\", 0)}')
    print(f'  Total Relationships: {stats.get(\"total_relationships\", 0)}')
    print(f'  Active Connections: {stats.get(\"active_connections\", 0)}')
"
}

cmd_stats() {
    print_header "Registry Statistics"
    check_registry || return 1
    
    curl -s "${REGISTRY_API}/stats" | python3 -c "
import sys, json
data = json.load(sys.stdin)
print(f'Total Entities: {data.get(\"total_entities\", 0)}')
print(f'Total Relationships: {data.get(\"total_relationships\", 0)}')

if 'by_type' in data:
    print(f'\nBy Type:')
    for t, count in data['by_type'].items():
        print(f'  {t}: {count}')

if 'by_status' in data:
    print(f'\nBy Status:')
    for s, count in data['by_status'].items():
        print(f'  {s}: {count}')

if 'by_health' in data:
    print(f'\nBy Health:')
    for h, count in data['by_health'].items():
        print(f'  {h}: {count}')
"
}

cmd_dashboard() {
    print_info "Opening Universal Registry Dashboard..."
    local url="http://localhost:8080"
    
    check_registry || return 1
    
    if [ -n "${BROWSER:-}" ]; then
        "$BROWSER" "$url" 2>/dev/null &
    elif command -v xdg-open &>/dev/null; then
        xdg-open "$url" 2>/dev/null &
    elif command -v open &>/dev/null; then
        open "$url" 2>/dev/null &
    else
        echo ""
        echo -e "${CYAN}${ICON_INFO}${NC} Dashboard URLs:"
        echo ""
        echo -e "  ${GREEN}Main Dashboard:${NC}       $url"
        echo -e "  ${GREEN}API Documentation:${NC}    $url/docs"
        echo -e "  ${GREEN}ReDoc:${NC}                $url/redoc"
        echo -e "  ${GREEN}Health Check:${NC}         $url/health"
        echo -e "  ${GREEN}Metrics:${NC}              $url/metrics"
    fi
}

cmd_setup() {
    print_info "Launching Intelligent Setup Wizard..."
    if [ -f /workspaces/terminal/modules/universal-registry/core/setup/wizard.py ]; then
        python3 /workspaces/terminal/modules/universal-registry/core/setup/wizard.py
    else
        print_error "Setup wizard not found"
    fi
}

cmd_version() {
    print_header "Universal Hyper Registry CLI $CLI_VERSION"
    echo "API Endpoint: $REGISTRY_API"
    echo "Database: $REGISTRY_DB"
    
    if check_registry 2>/dev/null; then
        local version=$(curl -s "${REGISTRY_API%/api/v1}/" | python3 -c "import sys, json; print(json.load(sys.stdin).get('version', 'unknown'))" 2>/dev/null || echo "unknown")
        echo "Registry Version: $version"
        print_success "Connected to registry"
    else
        print_warning "Registry not reachable"
    fi
}

cmd_help() {
    cat << 'EOF'

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘        Universal Hyper Registry - Complete CLI vâˆž.9       â•‘
â•‘          Full Platform Control Interface                   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PLUGIN MANAGEMENT:
  plugin list              List all registered plugins
  plugin register          Register a new plugin
  plugin install <id>      Install plugin
  plugin activate <id>     Activate/enable plugin
  plugin deactivate <id>   Deactivate/disable plugin
  plugin uninstall <id>    Uninstall/remove plugin
  plugin info <id>         Show plugin details
  plugin update <id>       Update plugin
  plugin health <id>       Check plugin health
  plugin logs <id>         View plugin logs

MICROSERVICES MANAGEMENT:
  service list             List all microservices
  service register         Register new microservice
  service start <id>       Start microservice
  service stop <id>        Stop microservice
  service restart <id>     Restart microservice
  service logs <id>        View service logs
  service health <id>      Check service health

EVENT STREAMS:
  stream list              Show stream statistics
  stream subscribe [type]  Subscribe to event streams
  stream publish           Publish custom event

WEBHOOKS:
  webhook list             List all webhooks
  webhook add              Register new webhook
  webhook delete <id>      Delete webhook
  webhook test <id>        Test webhook delivery

SEARCH & DISCOVERY:
  search <query>           Search across all entities
  index add                Add document to search index
  index stats              Show search index statistics
  index rebuild            Rebuild search index

DEPENDENCIES & RELATIONSHIPS:
  graph <id> [depth]       Show dependency graph
  feature list             List feature categories

SYSTEM OPERATIONS:
  health                   System health check
  stats                    Show detailed statistics
  dashboard                Open WebUI dashboard
  setup                    Run intelligent setup wizard
  version                  Show version information
  help                     Show this help message

EXAMPLES:
  # Plugin management
  universal-registry-cli plugin list
  universal-registry-cli plugin register
  universal-registry-cli plugin activate my-plugin
  universal-registry-cli plugin logs my-plugin

  # Microservices
  universal-registry-cli service list
  universal-registry-cli service start my-service
  universal-registry-cli service logs my-service

  # Event streaming
  universal-registry-cli stream subscribe entity.created
  universal-registry-cli stream publish

  # Search
  universal-registry-cli search "machine learning"
  universal-registry-cli graph plugin-123 5

  # System
  universal-registry-cli health
  universal-registry-cli dashboard
  universal-registry-cli setup

ENVIRONMENT VARIABLES:
  UNIVERSAL_REGISTRY_API    API endpoint (default: http://localhost:8080/api/v1)
  UNIVERSAL_REGISTRY_DB     Database path
  BROWSER                   Browser command for dashboard

DOCUMENTATION:
  API Docs:     http://localhost:8080/docs
  Features:     /modules/universal-registry/ENTERPRISE_FEATURES.md

EOF
}

# ==================== MAIN COMMAND ROUTER ====================

main() {
    local cmd="${1:-help}"
    shift || true

    case "$cmd" in
        plugin|plugins|plg|pl)
            cmd_plugin "$@"
            ;;
        service|services|svc|microservice|microservices)
            cmd_service "$@"
            ;;
        stream|streams|event|events)
            cmd_stream "$@"
            ;;
        webhook|webhooks|hook|hooks)
            cmd_webhook "$@"
            ;;
        search|find)
            cmd_search "$@"
            ;;
        index|idx)
            cmd_index "$@"
            ;;
        feature|features|feat)
            cmd_feature "$@"
            ;;
        graph|deps|dependencies)
            cmd_graph "$@"
            ;;
        health|status)
            cmd_health "$@"
            ;;
        stats|statistics|metrics)
            cmd_stats "$@"
            ;;
        dashboard|ui|web|webui)
            cmd_dashboard
            ;;
        setup|configure|wizard)
            cmd_setup
            ;;
        version|v|-v|--version)
            cmd_version
            ;;
        help|h|-h|--help)
            cmd_help
            ;;
        *)
            print_error "Unknown command: $cmd"
            echo ""
            echo "Run 'universal-registry-cli help' for usage information"
            exit 1
            ;;
    esac
}

main "$@"
